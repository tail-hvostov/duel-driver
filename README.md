# duel-driver
## Описание проекта
Задачей проекта Duel является написание драйвера для монохромного SPI-дисплея с разрешением 72x40, использующего контроллер SSD1306. Целевой платформой проекта является одноплатный компьютер OrangePi Zero 3 с ОС Armbian Linux 6.6.62-current-sunxi64.
## Установка дисплея
### Подключение к OrangePi
- VCC - 3v3
- SCL - PH6
- SDA - PH7
- RES - PC10
- DC  - PC7
- CS  - PH9
### Регистрация в Device Tree (выполняется однократно)
Важно! Перед выполнением указанных команд следует в Терминале перейти в директорию duel-driver.

Выполните следующие команды в Терминале:
```
dtc -@ -I dts -O dtb -o ssd1306.dtbo ssd1306-overlay.dts
sudo cp ssd1306.dtbo /boot/dtb/allwinner/overlay/sun50i-h616-ssd1306.dtbo
sudo nano /boot/armbianEnv.txt
```
В открывшемся документе следует найти строку вида ```overlays=xxx yyy ...``` и привести её к следующему виду:
```
overlays=xxx yyy ... ssd1306
```
Если в документе нет строки подобного вида, её можно добавить в конец файла следующим образом:
```
overlays=ssd1306
```
После выполнения всех вышеперечисленных операций перезагрузите устройство командой ```sudo reboot```.
## Простые загрузка и отключение драйвера (без автозапуска)
Важно! Перед выполнением указанных команд следует в Терминале перейти в директорию duel-driver.

Загрузка драйвера осуществляется командами:
```
make
sudo scripts/duel_load.sh
```

Отключение драйвера осуществляется командой ```sudo scripts/duel_unload.sh```.
## Описание драйвера
При загрузке Duel в директории /dev порождаются файлы трёх символьных устройств:
- /dev/duel0 - файл строкового устройства для записи текста;
- /dev/duel1 - файл быстрого сырого устройства для записи обычных графических данных;
- /dev/duel2 - файл простого сырого устройства для записи обычных графических данных.
### Взаимные ограничения устройств
Все выше перечисленные устройства являются постоянно доступными, но их совместное использование накладывает следующие ограничения:
- в любой момент может существовать не более одного файлового декскриптора с разрешением на запись;
- если существует хотя бы один файловый дескриптор с разрешением на сырую запись, то строковое чтение невозможно;
- если существует хотя бы один файловый дескриптор с разрешением на строковое чтение, то сырая запись невозможна.

Попытки открыть файловый дескриптор в заданных условиях пресекаются.
### /dev/duel1
Запись и чтение, осуществляемые над этим файлом производятся в быстром сыром режиме. Это означает, что duel1 работает с наборами пикселей в формате, характерном для Page Addressing Mode контроллера SSD1306. В этом формате все пиксели разделены на некоторое число т.н. страниц. Страница - группа из 8 смежных строк пикселей на экране. Страницы между собой не пересекаются. В памяти страница представлена некоторым числом байтов, равному ширине экрана, где каждый байт представляет состояние соответствующего 8-пиксельного столбца в странице. 8-ой бит байта соответствует самому нижнему пикселю в столбце. В duel1 данные соответствуют нескольким последовательным блокам памяти, представляющим отдельные страницы в порядке сверху-вниз.

Для лучшего понимания принципа работы /dev/duel1 рекомендуется ознакомиться с datasheet к SSD1306.

/dev/duel1 поддерживает системный вызов lseek.
### /dev/duel2
Запись и чтениие, осуществляемые над этим файлом производятся в сыром режиме. В duel2 данные соответствуют нескольким последовательным блокам памяти, представляющим строки дисплея в порядке сверху-вниз. /dev/duel2 поддерживает системный вызов lseek.
## Тестирование
Для проверки работы драйвера можно запустить несколько автоматических тестов. Для их использования требуется выполнить следующие операции:
1. Начальная подготовка тестов (выполняется однократно). Выполните команду: ```make tests```
2. Запуск тестов. Выполните команду: ```scripts/duel_test.sh```

Важно! Перед выполнением указанных команд следует в Терминале перейти в директорию duel-driver.
## Тестирование
Вместе с драйвером также прилагается ряд программ, являющихся примерами работы с драйвером. Для их сборки следует в Терминале перейти в директорию duel-driver и выполнить команду ```make examples```. Исходные тексты примеров находятся в папке examples, а исполняемые файлы помещаются в папку examples/compiled.